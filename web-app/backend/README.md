# User Authentication System

This project is a user authentication system using Supabase as the database backend and bcrypt for securely hashing passwords. It provides endpoints to register and log in users.

## Setup

### Prerequisites

- Node.js and npm installed
- Supabase account and project
- `dotenv` library for managing environment variables
- `bcrypt` library for hashing passwords
- `jsonwebtoken` library for creating JWT tokens

### Installation

1. Clone the repository:

   ```
   git clone <repository-url>
   ```

### Navigate to the project directory:

```
 cd <project-directory>
```

### Install dependencies:

```
 npm install
```

### Create a `.env` file in the root of the project and add your Supabase credentials:

```
   SUPABASE_URL=your-supabase-url
   SUPABASE_KEY=your-supabase-key
   JWT_SECRET=your-secret-key
```

### Ensure that your `users` table exists in Supabase with the following schema:

```SQL
    create table public.users (
    id bigint generated by default as identity not null,
    name text not null,
    surname text not null,
    email text not null,
    password text not null,
    constraint users_pkey primary key (id),
    constraint users_email_key unique (email)
    );
```

### Optionally, create a table for storing invalidated tokens (logging out):

```SQL
   create table public.invalidated_tokens (
   id bigint generated by default as identity not null,
   token text not null,
   constraint invalidated_tokens_pkey primary key (id)
    );
```

## Endpoints

### 1. Register User

This endpoint registers a new user by inserting their details into the database. The password is hashed before being saved.

### HTTP Method: POST

### Endpoint: /register

### Request Body:

```JSON
     {
         "name": "John",
         "surname": "Doe",
         "phone":"0987654321",
         "email": "johndoe@example.com",
         "password": "Securep@ssword123"
     }
```

### Response:

```JSON
      {
         "id": 35,
         "name": "John",
         "surname": "Doe",
         "email": "johndoe@example.com",
         "phone": "0987654321"
      }
```

### Errors:

400 Bad Request: Invalid email or password.
409 Conflict: Email already exists.
500 Internal Server Error: Server error.

### Code Snippet

```JavaScript
     async function registerUser(name, surname, email, password) {

     const hashedPassword = await bcrypt.hash(password, 10);

     const { data, error } = await supabase
         .from('users')
         .insert([{ name, surname, email, password: hashedPassword }]);

     if (error) {
         console.error('Error:', error);
         return null;
     }

     return data;
     }
```

### 2. Login User

This endpoint authenticates a user by verifying their email and password. The provided password is compared with the stored hashed password in the database.

### HTTP Method: POST

### Endpoint: /login

### Request Body:

```JSON
     {
         "email": "johndoe@example.com",
         "password": "Securep@ssword123"
     }
```

### Response

```JSON
     {
         "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6..."
     }
```

### Errors:

400 Bad Request: Invalid email or password.
404 Not Found: User not found.
500 Internal Server Error: Server error.

### Code Snippet:

```JavaScript
     async function loginUser(email, password) {
     const { data: user, error } = await supabase
         .from('users')
         .select('*')
         .eq('email', email)
         .single();

     if (error || !user) {
         console.error('Error fetching user:', error);
         return null;
     }

     const passwordMatch = await bcrypt.compare(password, user.password);

     if (!passwordMatch) {
         console.error('Invalid password');
         return null;
     }

     const { password: _, ...userData } = user;
     return userData;
     }
```

### 3. Logout User

POST/logout

This endpoint logs out a user by storing the JWT token in an "invalidated tokens" table. This ensures the token is no longer valid and can't be reused.

### Request Body

```
     {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6...
     }

```

### Response

```
   {
      "message": "Logged out successfully"
   }
```

### Code Snippet

```JavaScript
        async function logoutUser(token) {
        const { data, error } = await supabase
            .from('invalidated_tokens')  // Table to store invalidated tokens
            .insert([{ token }]); // Insert the token into the table

        if (error) {
            console.error('Error invalidating token:', error.message);
            return { message: 'Logout failed.' };
        }

        return { message: 'Logged out successfully' };
        }
```

## Token Expiration & Invalidity

- `JWT Expiry`: The JWT tokens generated during login have a default expiration time of 5 minutes. After this time, the token is no longer valid, and the user will need to log in again.
- `Token Invalidation`: Upon logout, the JWT token is added to the invalidated_tokens table, preventing it from being reused.

## Token Verification Middleware

To verify a token before granting access to protected routes, the following middleware function can be used:

### Code Snippet

```
        function verifyToken(token) {
        try {
            return jwt.verify(token, process.env.JWT_SECRET);
        } catch (err) {
            return null; // Token is invalid or expired
        }
        }
```

### 4. Query input

This endpoint processes a user query and returns a response with the processed query, userID and server secret

### HTTP Method: POST

### Endpoint: /QRY

### Request Body

```JSON
        {
            "query": "hello"
        }
```

### Response

```JSON
    {
        "status": "success",
        "data": {
            "query": "hello",
            "result": "Processed query: hello",
            "userID": "Blackbeard",
            "server_secret": "as)#)(AFJS82)24121SKLFIU9322386656fj209KKJJDAAKJKII"
        }
    }
```

### Errors

404 Bad Request: Query cannot be empty

```JSON
    {
        "success": false,
        "message": "Query cannot be empty"
    }
```

### Code Snippet:

```JavaScript
    app.post('/qry', async (req, res) => {
        const { query } = req.body;

        // Validate the query
        if (!query || query.trim() === "") {
            return res.status(400).json({
                success: false,
                message: "Query cannot be empty"
            });
        }

        // Process the query (this is just an example)
        const processedQuery = `Processed query: ${query}`;

        // Return the response
        res.json({
            status: "success",
            data: {
                query: query,
                result: processedQuery,
                userID: "Blackbeard",
                server_secret: "as)#)(AFJS82)24121SKLFIU9322386656fj209KKJJDAAKJKII"
            }
        });
    });
```

## Database Configuration

The db.js file manages the connection to Supabase and sets up the environment variables for connecting to the database.

### Code Snippet:

```JavaScript
     import { createClient } from '@supabase/supabase-js';
     import dotenv from 'dotenv';

     dotenv.config();

     const supabaseUrl = process.env.SUPABASE_URL;
     const supabaseKey = process.env.SUPABASE_KEY;

     export const supabase = createClient(supabaseUrl, supabaseKey);
```

## Future Improvements:

-> `Token-Based Authentication:` Implement `JWT (JSON Web Token)` for session management instead of returning the entire user object in the login response.

-> `API Endpoints:`

- Implement Express.js routes for `/register` and `/login`.
- Validate requests (e.g., check if email already exists before registering).

-> `Authentication & Session Management:`

- Implement `JWT (JSON Web Token)` authentication.
- Modify `loginUser()` to return a token instead of full user data.
- Add middleware to verify tokens in protected routes.

-> `Additional Authentication Features:`

- Implement `POST /logout` to invalidate tokens (if needed).
- Implement `POST /reset-password` to handle password reset requests.

-> `Database Improvements:`

- Add an `updated_at` timestamp field to track changes.
- Consider switching to **Supabase Auth** instead of manual authentication.

-> `Frontend Integration Support:`

- Provide a sample `.env.example` file with expected environment variables.
- Document expected API requests & responses (mock JSON for UI team).
- Write a simple test script to verify API endpoints.

------------------------------------------------------ The End, Thank You! -----------------------------------------------------------------
